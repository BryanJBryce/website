<!DOCTYPE html>
<html>
  <head>
    <title>OpenID in Rails einbinden | Dennis Reimann, Softwareentwickler</title>
    <script src='/javascripts/head.min.js'></script>
    <script type='text/javascript'>
      //<![CDATA[
        head.js(
          "https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js",
          "http://www.google-analytics.com/ga.js",
          "/fancybox/jquery.fancybox-1.3.4.pack.js",
          "/fancybox/jquery.easing-1.3.pack.js",
          "/javascripts/website.js",
          function(){Website.init()});
      //]]>
    </script>
    <link href='/atom.xml' rel='alternate' title='//dennisreimann' type='application/atom+xml' />
    <link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css' />
    <link href='/stylesheets/screen.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <link href='http://dennisreimann.de/blog/openid-in-rails-einbinden' rel='canonical' />
    <link href='http://openid.dennisreimann.de/server' rel='openid2.provider openid.server' />
    <link href='http://openid.dennisreimann.de/dennisreimann' rel='openid2.local_id openid.delegate' />
    <!--[if IE]>
      <link href='/stylesheets/ie.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <![endif]-->
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
    <meta content='BRi3ql7JvxxFP2KtBRHIV6Rfzn0ZN7xJF1NNtnEUaI8' name='google-site-verification' />
    <meta content='app-id=669642611,affiliate-data=10l5ET' name='apple-itunes-app' />
    <meta content='Das Integrieren von OpenID in eine Rails-Anwendung wird einem ziemlich leicht gemacht: Wer es weniger flexibel, dafür aber umso schneller fertig haben möchte, für den eignet sich das OpenID Consumer Plugin. Wer allerdings lieber selbst wissen möchte, was wie funktioniert, der kann das OpenID Login auch in wenigen Schritten selbst implementieren.' name='description' />
    <meta content='OpenID, Ruby on Rails' name='keywords' />
  </head>
  <body>
    <div id="header">
      <div id='identity'>
        <a href='/' id='logo'>
          <span id='slashes'>//</span>
          <span id='name'>dennisreimann</span>
        </a>
        <div id='claim'>
          Softwareentwickler
        </div>
      </div>
    </div>
    <div id="main">
      <article>
        <header>
          <time class='pubdate' datetime='2007-03-03T10:58:00+01:00'>
            <div class='top'>Mar '07</div>
            <div class='day'> 3</div>
          </time>
          <h1>OpenID in Rails einbinden</h1>
        </header>
        <div class='content'><p>Das Integrieren von OpenID in eine Rails-Anwendung wird einem ziemlich leicht gemacht: Wer es weniger flexibel, dafür aber umso schneller fertig haben möchte, für den eignet sich das OpenID <a href="http://identity.eastmedia.com/identity/show/Consumer+Plugin">Consumer Plugin</a>. Wer allerdings lieber selbst wissen möchte, was wie funktioniert, der kann das OpenID Login auch in wenigen Schritten selbst implementieren.</p>&#x000A;&#x000A;<h4>1. Installieren der Library</h4>&#x000A;&#x000A;&#x000A;<p>Für den Umgang mit OpenID (sowohl Consumer als auch Sever) gibt es bereits das <a href="http://www.openidenabled.com/openid/libraries/ruby/">Ruby-OpenID Gem</a>. Da wir dessen Funktionalität nutzen wollen, muss es zunächst installiert werden. Einfach über die Konsole</p>&#x000A;&#x000A;<pre>$ sudo gem install ruby-openid -y</pre>&#x000A;&#x000A;&#x000A;<p>eingeben. Dadurch werden das Gem und die nötigen Abhängigkeiten (<code>-y</code> ist die Abkürzung für <code>--include-dependencies</code>) lokal installiert.</p>&#x000A;&#x000A;<h4>2. Der OpenID Controller</h4>&#x000A;&#x000A;&#x000A;<p>Um die nötigen Funktionen zu implementieren brauchen wir nur einen Controller und vier dazugehörige Actions. Um die OpenID-Funktionalität vom Rest der Anwendung zu trennen, empfiehlt es sich, einen neuen Controller zu generieren:</p>&#x000A;&#x000A;<pre>./script/generate controller Openid login begin complete openid_consumer</pre>&#x000A;&#x000A;&#x000A;<p>Der Befehl erzeugt uns den <code>OpenidController</code> mit den Actions <code>login</code>, <code>begin</code>, <code>complete</code> und <code>openid_consumer</code>, welche wir nacheinander implementieren werden. Bevor es damit allerdings losgehen kann, muss in Zeile 1 des neuen Controllers das in Schritt 1 installierte Gem eingebunden werden:</p>&#x000A;&#x000A;<pre>require_gem 'ruby-openid'</pre>&#x000A;&#x000A;&#x000A;<p>Damit stehen uns im Controller alle Funktionen des Gems bereit, welche wir für die Implementierung der Actions nutzen wollen. Der Controller dürfte bis dahin so aussehen:</p>&#x000A;&#x000A;<pre>require_gem 'ruby-openid'&#x000A;class OpenidController &lt; ApplicationController&#x000A;&#x000A;  def login&#x000A;  end&#x000A;&#x000A;  def begin&#x000A;  end&#x000A;&#x000A;  def complete&#x000A;  end&#x000A;&#x000A;  def openid_consumer&#x000A;  end&#x000A;&#x000A;end</pre>&#x000A;&#x000A;&#x000A;<h4>3. openid_consumer</h4>&#x000A;&#x000A;&#x000A;<p>Wir fangen mit der Action <code>openid_consumer</code> an und markieren sie als <code>protected</code>, da sie nur Controller-intern verwendet werden wird und daher kein Zugriff über die URL erlaubt werden soll.</p>&#x000A;&#x000A;<pre>  protected&#x000A;    def openid_consumer&#x000A;      @openid_consumer ||= OpenID::Consumer.new(session,&#x000A;        OpenID::FilesystemStore.new("#{RAILS_ROOT}/tmp/openid"))&#x000A;    end</pre>&#x000A;&#x000A;&#x000A;<p>Der Einzeiler erstellt eine Openid-Consumer Instanz: Das erste Argument muss ein Hash-Objekt sein, welches die Sessiondaten speichert (in Rails also <code>session</code>) und der zweite Parameter legt fest, wo die Daten des Verifizierungsprozesses abgelegt werden sollen. In diesem Fall nehmen wir das Dateisystem - es ist allerdings auch möglich, die Datenbank zu nutzen (das in der Einleitung erwähnte Plugin macht es über Active Record).</p>&#x000A;&#x000A;<h4>4. login</h4>&#x000A;&#x000A;&#x000A;<p>In der Action <code>login</code> braucht nichts weiter passieren, es geht lediglich darum, den View mit dem Formular bereitzustellen, welches im einfachsten Falle irgendwie so aussieht:</p>&#x000A;&#x000A;<pre>&lt;% form_tag url_for(:action =&gt; :begin) do %&gt;&#x000A;  &lt;%= text_field_tag 'openid_url'  %&gt;&#x000A;  &lt;%= submit_tag "mit OpenID einloggen" %&gt;&#x000A;&lt;% end -%&gt;</pre>&#x000A;&#x000A;&#x000A;<p>Laut Konvention sollte man immer das OpenID-Logo als <a href="http://openid.net/login-bg.gif">Hintergrundbild für das Loginfeld</a> einbinden, was sich mit folgendem CSS leicht tun lässt:</p>&#x000A;&#x000A;<pre>#openid_url {&#x000A;  background: url(/images/login-bg.gif) no-repeat #FFF 5px;&#x000A;  padding-left: 25px;&#x000A;}</pre>&#x000A;&#x000A;&#x000A;&#x000A;&#x000A;<h4>5. begin</h4>&#x000A;&#x000A;&#x000A;<p>Nächster Schritt ist die Action <code>begin</code>, welche die aus dem Formular abgeschickten Anfragen annimmt und verarbeitet.</p>&#x000A;&#x000A;<pre>  def begin&#x000A;    openid = params[:openid_url]&#x000A;    response = openid_consumer.begin openid&#x000A;    if response.status == OpenID::SUCCESS&#x000A;      # Daten anfordern - siehe Spec:&#x000A;      # http://openid.net/specs/openid-simple-registration-extension-1_0.html&#x000A;      response.add_extension_arg('sreg','required','nickname,email')&#x000A;      response.add_extension_arg('sreg','optional','fullname')&#x000A;      # Request senden - erster Parameter = Trusted Site,&#x000A;      # zweiter Parameter = anschließende Weiterleitung&#x000A;      redirect_to response.redirect_url(home_url, openid_complete_url)&#x000A;    else&#x000A;      flash[:error] = "Der OpenID-Server <strong>#{openid}</strong> war nicht erreichbar."&#x000A;      redirect_to url_for(:action =&gt; :login)&#x000A;    end&#x000A;  end</pre>&#x000A;&#x000A;&#x000A;<p>Im Falle eines erfolgreichen Response des vom User angegebenen OpenID-Servers wird ein Request mit der Anforderung der Userdaten gesendet. In diesem Fall werden die Daten <code>nickname</code> und <code>email</code> zwingend angefordert, <code>fullname</code> ist optional. Darüber hinaus gibt es noch weitere Daten, welche man über das OpenID-Login beziehen kann, eine genaue Auflistung findet sich in der <a href="http://openid.net/specs/openid-simple-registration-extension-1_0.html#response_format">Spezifikation des Response-Formats</a>.</p>&#x000A;&#x000A;<p>Der Request zum Abschließen der Verifikation wird mit zwei Parametern an den OpenID-Server geschickt: Beim ersten Parameter handelt es sich um die URL der Website, welcher der User die Daten zur Verfügung stellt (also die Basis-URL unserer Anwendung - in diesem Fall über <a href="/blog/rails-routes-benennen/">benannte Routes</a> die <code>home_url</code>. Der zweite Parameter legt fest, wo die anschließende Verarbeitung des Request stattfinden soll, also in unserer <code>complete</code> Action (wäre ohne benannte Routes <code>url_for(:controller =&amp;gt; :openid, :action =&amp;gt; :complete)</code>).</p>&#x000A;&#x000A;<h4>6. complete</h4>&#x000A;&#x000A;&#x000A;<p>Hier nun also der letzte Schritt, in welchem die Antwort mit der OpenID-Verifizierung verarbeitet wird.</p>&#x000A;&#x000A;<pre>  def complete&#x000A;    response = openid_consumer.complete params&#x000A;    openid = response.identity_url&#x000A;    if response.status == OpenID::SUCCESS&#x000A;      # Hier muss das Login implementiert werden,&#x000A;      # also Session befüllen oder sonstige Aktionen.&#x000A;      # Die Daten stehen als&#x000A;      # params["openid.sreg.nickname"]&#x000A;      # etc. zur Verfügung&#x000A;      end&#x000A;    else&#x000A;      flash[:error] = "Das Login mit der OpenID <strong>#{openid}</strong> war nicht erfolgreich."&#x000A;      redirect_to login_url&#x000A;    end&#x000A;  end</pre>&#x000A;&#x000A;&#x000A;<p>Wie das letztendliche Login aussieht (Eintragen in Session, Erstellen eines Benutzerkontos oder ähnliches), hängt von der Anwendung ab und muss im auskommentierten Teil selbst implementiert werden. Die vom OpenID-Server gelieferten Daten des Users stehen über <code>params["openid.sreg.nickname"]</code> bereit.</p>&#x000A;&#x000A;<h4>Anmerkungen</h4>&#x000A;&#x000A;&#x000A;<p>Beim Schreiben des Tutorials habe ich mich an Dan Webbs <a href="http://www.danwebb.net/2007/2/27/the-no-shit-guide-to-supporting-openid-in-your-applications">No Shit Guide To Supporting OpenID In Your Applications</a> orientiert. Mittlerweile gibt es auch vom Rails Core Team das <a href="http://dev.rubyonrails.org/browser/plugins/open_id_authentication">OpenID Authentication</a> Plugin, welches auch als Wrapper für die Funktionen des Ruby-OpenID Gems dient.</p></div>
        <div class='follow'>
          <p>
            Guter Artikel? Folge mir auf
            <a class="twitter" href="https://twitter.com/dennisreimann">Twitter</a>
            oder
            <a class="github" href="https://github.com/dennisreimann">GitHub</a>
          </p>
        </div>
        <div class='teaser' id='iOctocat' itemscope='itemscope' itemtype='http://schema.org/SoftwareApplication'>
          <a href='http://ioctocat.com'>
            <img alt='iOS app for GitHub' itemprop='image' src='/images/ioctocat.png' />
          </a>
          <h3 itemprop='name'>
            <a href='http://ioctocat.com'>iOctocat</a>
          </h3>
          <p itemprop='description'>
            ist GitHub für die Hosentasche - deine Projekte und das was dort passiert
            immer dabei mit deinem
            <span itemprop='device'>iPhone und iPod Touch.</span>
            <br />
            Die App ist
            <a href="http://ioctocat.com/appstore-iphone" itemprop="url">im App Store erhältlich</a>
          </p>
          <link href='http://schema.org/SocialNetworkingApplication' itemprop='SoftwareApplicationCategory' />
        </div>
      </article>
    </div>
    <div id="footer">
      <div class='vcard' id='contact'>
        <span class='fn'>Dennis Reimann</span>
        <p class='adr'>
          <span class='street-address'>Ottjen-Alldag-Str. 32</span>
          <br />
          <span class='postal-code'>D-28277</span>
          <span class='locality'>Bremen</span>
        </p>
        <p>
          <span class='web'><a class="url" href="http://dennisreimann.de/" rel="me">dennisreimann.de</a></span>
          <br />
          <span class='mail'><a class="email" href="mailto:mail@dennisreimann.de" rel="me">mail@dennisreimann.de</a></span>
          <br />
          <span class='tel'>+49 (0)151 22 63 03 17</span>
        </p>
        <p>
          <small><a href="/contact">Kontaktdetails</a></small>
        </p>
        <ul class='social'>
          <li><a href="https://github.com/dennisreimann" rel="me">GitHub</a></li>
          <li><a href="https://twitter.com/dennisreimann" rel="me">Twitter</a></li>
          <li><a href="http://www.xing.com/profile/Dennis_Reimann5" rel="me">XING</a></li>
        </ul>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-376258-21']);
        _gaq.push(['_gat._anonymizeIp']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
        })();
      //]]>
    </script>
  </body>
</html>
