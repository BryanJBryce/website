<!DOCTYPE html>
<html>
  <head>
    <title>Probleme mit Mongrel Threads | Dennis Reimann, Softwareentwickler</title>
    <script src='/javascripts/head.min.js'></script>
    <script type='text/javascript'>
      //<![CDATA[
        head.js(
          "https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js",
          "http://www.google-analytics.com/ga.js",
          "/fancybox/jquery.fancybox-1.3.4.pack.js",
          "/fancybox/jquery.easing-1.3.pack.js",
          "/javascripts/website.js",
          function(){Website.init()});
      //]]>
    </script>
    <link href='/atom.xml' rel='alternate' title='//dennisreimann' type='application/atom+xml' />
    <link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css' />
    <link href='/stylesheets/screen.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <link href='http://dennisreimann.de/blog/probleme-mit-mongrel-threads' rel='canonical' />
    <link href='http://openid.dennisreimann.de/server' rel='openid2.provider openid.server' />
    <link href='http://openid.dennisreimann.de/dennisreimann' rel='openid2.local_id openid.delegate' />
    <!--[if IE]>
      <link href='/stylesheets/ie.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <![endif]-->
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
    <meta content='BRi3ql7JvxxFP2KtBRHIV6Rfzn0ZN7xJF1NNtnEUaI8' name='google-site-verification' />
    <meta content='app-id=669642611,affiliate-data=10l5ET' name='apple-itunes-app' />
    <meta content='Beim Durchsehen unserer Logs fiel uns in den letzten Tagen auf, dass sich Apache zunehmend drüber beschwerte, einzelne Mongrel-Instanzen nicht mehr connecten zu können (unser Setup: Apache 2.2, mod_proxy_balancer und dahinter eine Armee aus sechs Mongrels).' name='description' />
    <meta content='Mongrel, Ruby on Rails, Server' name='keywords' />
  </head>
  <body>
    <div id="header">
      <div id='identity'>
        <a href='/' id='logo'>
          <span id='slashes'>//</span>
          <span id='name'>dennisreimann</span>
        </a>
        <div id='claim'>
          Softwareentwickler
        </div>
      </div>
    </div>
    <div id="main">
      <article>
        <header>
          <time class='pubdate' datetime='2007-09-28T09:30:00+02:00'>
            <div class='top'>Sep '07</div>
            <div class='day'>28</div>
          </time>
          <h1>Probleme mit Mongrel Threads</h1>
        </header>
        <div class='content'><p>Beim Durchsehen unserer Logs fiel uns in den letzten Tagen auf, dass sich Apache zunehmend drüber beschwerte, einzelne Mongrel-Instanzen nicht mehr connecten zu können (unser Setup: Apache 2.2, mod_proxy_balancer und dahinter eine Armee aus sechs Mongrels).&#x000A;Im Apache error.log macht sich das folgendermaßen bemerkbar:</p>&#x000A;&#x000A;<pre>proxy: error reading status line from remote server 127.0.0.1:PORTNR</pre>&#x000A;&#x000A;&#x000A;<p>Guckt man sich darauf hin das mongrel.log zum Mongrel auf dem jeweiligen Port an, so findet man folgendes:</p>&#x000A;&#x000A;<pre>Reaping x threads for slow workers because of 'shutdown'</pre>&#x000A;&#x000A;&#x000A;<p>Beim danach googlen haben wir wenig gefunden, was uns wirklich weitergeholfen hat, daher haben wir es einfach mal mit der Lösung versucht, di in <a href="http://groups.google.com/group/MephistoBlog/browse_thread/thread/38d8db08beef1444">diesem Thread</a> angepriesen wird: Das <a href="http://tmtm.org/en/mysql/ruby/">MySQL-Gem</a> neu installieren bzw. konfigurieren (mit den Optionen <code>--with-mysql-config[=/path/to/mysql_config]</code> und <code>--with-mysql-dir=/mysql/dir</code>). Es gibt zwar keinerlei Hinweis darauf, warum das Problem grade damit zusammenhängt, aber es hat geholfen, so dass ich es nicht unerwähnt lassen wollte, falls sich jemand mit ähnlichen Problemen auf die Suche begibt.</p>&#x000A;&#x000A;<p>Falls jemand genaueres weiss, bitte melden, wir sind für wietere Hinweise sehr dankbar!</p>&#x000A;&#x000A;<h4>UPDATE</h4>&#x000A;&#x000A;&#x000A;<p>Okay, ich hätte das lieber nicht zu früh sagen sollen. Gestern Abend hatten wir das Problem erneut und es scheint eher zufällig unter erhöhter Last aufzukommen.  Eine lange Runde googlen später fand ich dann mehrere Hinweise darauf, dass es wohl mit einem MySQL-Verbindungsabbruch zusammenhängen könnte, wie auch schon die Jungs von <a href="http://upstream-berlin.com/blog/2007/07/18/mysql-lost-connection-error-in-grosen-rails-anwendungen/">Upstream</a> bemerkt haben.</p>&#x000A;&#x000A;<p>Das deckt sich auch mit Erklärungen in der <a href="http://mongrel.rubyforge.org/faq.html">Mongrel-FAQ</a>, wo es heisst:</p>&#x000A;&#x000A;<blockquote cite="http://mongrel.rubyforge.org/faq.html">If you find that Mongrel stops working after a long idle time and you’re using MySQL then you’re hitting a bug in the MySQL driver that doesn’t properly timeout connections. What happens is the MySQL server side of the connection times out and closes, but the MySQL client doesn’t detect this and just sits there.&#x000A;&#x000A;What you have to do is set:&#x000A;&#x000A;`ActiveRecord::Base.verification_timeout = 14400`&#x000A;&#x000A;Or to any value that is lower than the MySQL server’s interactive_timeout setting. This will make sure that ActiveRecord checks the connection often enough to reset the connection.</blockquote>&#x000A;&#x000A;&#x000A;<p>Macht Mongrel erst einmal &#8220;Sitz!&#8221; um auf die MySQL-Verbindung zu warten, dann bleibt er auch da, bis die Verbindung kommt. Da das MySQL-Gem ihm aber scheinbar nicht sagt, dass da keine Verbindung mehr kommt, bleibt er einfachÂ  sitzen&#8230; also lassen wir ihn jetzt mal per ActiveRecord wieder aufstehen.&#x000A;Erneutes Aportieren der Verbindung kann übrigens über das <a href="http://rubyforge.org/projects/zventstools/">mysql_retry_lost_connection</a> Gem befohlen werden&#8230; sorry, aber diese wahnwitzige Analogie musste ich jetzt einfach mal ausnutzen, hoffe es hilft ;)</p></div>
        <div class='follow'>
          <p>
            Guter Artikel? Folge mir auf
            <a class="twitter" href="https://twitter.com/dennisreimann">Twitter</a>
            oder
            <a class="github" href="https://github.com/dennisreimann">GitHub</a>
          </p>
        </div>
        <div class='teaser' id='iOctocat' itemscope='itemscope' itemtype='http://schema.org/SoftwareApplication'>
          <a href='http://ioctocat.com'>
            <img alt='iOS app for GitHub' itemprop='image' src='/images/ioctocat.png' />
          </a>
          <h3 itemprop='name'>
            <a href='http://ioctocat.com'>iOctocat</a>
          </h3>
          <p itemprop='description'>
            ist GitHub für die Hosentasche - deine Projekte und das was dort passiert
            immer dabei mit deinem
            <span itemprop='device'>iPhone und iPod Touch.</span>
            <br />
            Die App ist
            <a href="http://ioctocat.com/appstore-iphone" itemprop="url">im App Store erhältlich</a>
          </p>
          <link href='http://schema.org/SocialNetworkingApplication' itemprop='SoftwareApplicationCategory' />
        </div>
      </article>
    </div>
    <div id="footer">
      <div class='vcard' id='contact'>
        <span class='fn'>Dennis Reimann</span>
        <p class='adr'>
          <span class='street-address'>Ottjen-Alldag-Str. 32</span>
          <br />
          <span class='postal-code'>D-28277</span>
          <span class='locality'>Bremen</span>
        </p>
        <p>
          <span class='web'><a class="url" href="http://dennisreimann.de/" rel="me">dennisreimann.de</a></span>
          <br />
          <span class='mail'><a class="email" href="mailto:mail@dennisreimann.de" rel="me">mail@dennisreimann.de</a></span>
          <br />
          <span class='tel'>+49 (0)151 22 63 03 17</span>
        </p>
        <p>
          <small><a href="/contact">Kontaktdetails</a></small>
        </p>
        <ul class='social'>
          <li><a href="https://github.com/dennisreimann" rel="me">GitHub</a></li>
          <li><a href="https://twitter.com/dennisreimann" rel="me">Twitter</a></li>
          <li><a href="http://www.xing.com/profile/Dennis_Reimann5" rel="me">XING</a></li>
        </ul>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-376258-21']);
        _gaq.push(['_gat._anonymizeIp']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
        })();
      //]]>
    </script>
  </body>
</html>
