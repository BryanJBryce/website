<!DOCTYPE html>
<html>
  <head>
    <title>Rails-Hosting auf Uberspace | Dennis Reimann, Softwareentwickler</title>
    <script src='/javascripts/head.min.js'></script>
    <script type='text/javascript'>
      //<![CDATA[
        head.js(
          "https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js",
          "http://www.google-analytics.com/ga.js",
          "/fancybox/jquery.fancybox-1.3.4.pack.js",
          "/fancybox/jquery.easing-1.3.pack.js",
          "/javascripts/website.js",
          function(){Website.init()});
      //]]>
    </script>
    <link href='/atom.xml' rel='alternate' title='//dennisreimann' type='application/atom+xml' />
    <link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css' />
    <link href='/stylesheets/screen.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <link href='http://dennisreimann.de/blog/rails-hosting-auf-uberspace' rel='canonical' />
    <link href='http://openid.dennisreimann.de/server' rel='openid2.provider openid.server' />
    <link href='http://openid.dennisreimann.de/dennisreimann' rel='openid2.local_id openid.delegate' />
    <!--[if IE]>
      <link href='/stylesheets/ie.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <![endif]-->
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
    <meta content='BRi3ql7JvxxFP2KtBRHIV6Rfzn0ZN7xJF1NNtnEUaI8' name='google-site-verification' />
    <meta content='app-id=669642611,affiliate-data=10l5ET' name='apple-itunes-app' />
    <meta content='Anleitung zum Aufsetzen einer Ruby on Rails anwendung auf uberspace.de' name='description' />
    <meta content='Rails, Ruby, Ruby on Rails, Uberspace, Hosting, Vlad, Capistrano, Deployment' name='keywords' />
  </head>
  <body>
    <div id="header">
      <div id='identity'>
        <a href='/' id='logo'>
          <span id='slashes'>//</span>
          <span id='name'>dennisreimann</span>
        </a>
        <div id='claim'>
          Softwareentwickler
        </div>
      </div>
    </div>
    <div id="main">
      <article>
        <header>
          <time class='pubdate' datetime='2012-09-06T17:07:00+02:00'>
            <div class='top'>Sep '12</div>
            <div class='day'> 6</div>
          </time>
          <h1>Rails-Hosting auf Uberspace</h1>
        </header>
        <div class='content'><p><img src="/images/content/uberspace.png" alt="Uberspace - Hosting on Asteroids" />&#x000A;Ich bin großer Fan der einladenden Atmosphäre, Einfachheit und dem großartigen Support auf&#x000A;<a href="https://uberspace.de">Uberspace</a>. Konsequenterweise hab ich nun auch meine letzten privaten&#x000A;Projekte dorthin umgezogen und mich dabei auch mit dem Rails-Deployment auf Uberspace&#x000A;auseinander gesetzt.</p>&#x000A;&#x000A;<p>Für die ersten Schritte findet man im Wiki eine Anleitung mit allen generellen Einzelheiten zum&#x000A;<a href="http://uberspace.de/dokuwiki/cool:rails">Aufsetzen einer Rails-Anwendung auf Uberspace</a>. Der&#x000A;dort beschriebene Ansatz setzt der Einfachheit halber auf das manuelle Ausführen der einzelnen&#x000A;Schritte und das Ausliefern der Anwendung über FastCGI. Da das nicht unbedingt etwas ist, was&#x000A;man aus dem täglichen Rails-Kontext kennt, hier ein paar Hinweise und Learnings zur Automatisierung&#x000A;des Deployments und zur Verwendung alternativer Applikationsserver.</p>&#x000A;&#x000A;<h3>Automatisierung des Deployments</h3>&#x000A;&#x000A;<p>Wer seine Anwendungen mit Capistrano deployed, sollte einen Blick auf <a href="https://github.com/yeah/uberspacify">uberspacify</a>&#x000A;werfen, ein Gem das alle nötigen Capistrano-Scripte mitbringt, um den eigenen Uberspace startklar&#x000A;für das Rails-Hosting zu machen. Als Fan von <a href="/blog/deployment-with-vlad/">Vlad</a> habe ich mich von&#x000A;uberspacify inspirieren lassen und die nötigen <a href="https://github.com/dennisreimann/vlad-extras/blob/master/lib/vlad/uberspace.rb">Uberspace-Tasks für Vlad</a>&#x000A;geschrieben. Das Script enthält die wichtigsten Anmerkungen und Konfigurationshinweise, hier noch ein&#x000A;paar generelle Dinge:</p>&#x000A;&#x000A;<p>Die von Vlad/Capistrano benutzte Shell ist nicht die interaktive Shell, die man selbst beim&#x000A;Login über SSH bekommt. Um sicherzustellen, dass auch diese Tools die gleiche Konfiguration (bspw. den&#x000A;Pfad zu einer angepassten Ruby-Version) haben, sollten die <a href="http://uberspace.de/dokuwiki/cool:rails#ruby_aktivieren">Anweisungen dafür</a>&#x000A;in die <code>.bashrc</code> statt in die <code>.bash_profile</code> geschrieben werden.</p>&#x000A;&#x000A;<p>Die Anwendung selbst muss unterhalb <code>/var/www/virtual/username/</code> liegen, damit der Apache darauf&#x000A;zugreifen kann. Im einfachsten Fall würde man einfach in das <code>html</code>-Verzeichnis dort deployen, was aber&#x000A;mit der von den Deployment-Tools generierten Struktur (<code>current</code>, <code>releases</code>, <code>shared</code>) ungünstig ist,&#x000A;da diese dann im <code>DocumentRoot</code> des Webservers liegen. Ich mache es daher so, die Anwendung in&#x000A;<code>/var/www/virtual/username/rails/myapp</code> zu deployen und einen <a href="http://uberspace.de/dokuwiki/start:domain#in_sachen_webserver">Symlink mit dem Hostnamen der Domain</a>&#x000A;auf das darin liegende <code>current/public</code> zu setzen. Damit funktioniert dann auch der Zugriff aus die Assets&#x000A;der Anwendung problemlos, ohne weitere Einstellungen in der <code>.htaccess</code> machen zu müssen. Im Zusammenhang&#x000A;mit den so verwendeten Domains sollte man den <a href="http://uberspace.de/dokuwiki/start:domain#achtung_bei_rewriterules">Hinweis zum angepassten DocumentRoot</a>&#x000A;beachten.</p>&#x000A;&#x000A;<h3>Alternative Applikationsserver</h3>&#x000A;&#x000A;<p>Statt FastCGI benutze ich Thin, generell treffen die nachfolgenden Dinge aber auch zu, sollte man sich&#x000A;für die Verwendung von Unicorn, Puma, Mongrel oder Passenger Standalone entscheiden. Wichtig ist eigentlich&#x000A;nur, dass man den Applikationsserver auf hohen Port laufen lässt und ihn <a href="http://uberspace.de/dokuwiki/system:daemontools">mittels Daemontools überwacht</a>,&#x000A;so dass er auch unabhängig von Webserver-Restarts persistent läuft.</p>&#x000A;&#x000A;<p>Das <code>run</code>-Script dafür, sieht dann beispielsweise folgendermaßen aus:</p>&#x000A;&#x000A;<div class="highlight"><pre><span class="c">#!/bin/bash</span>&#x000A;<span class="nb">export </span><span class="nv">HOME</span><span class="o">=</span>/home/username&#x000A;<span class="nb">source</span> <span class="nv">$HOME</span>/.bash_profile&#x000A;<span class="nb">cd</span> /var/www/virtual/username/rails/myapp/current&#x000A;<span class="nb">exec</span> /home/username/.gem/ruby/1.9.1/bin/bundle <span class="nb">exec </span>thin start -p 43862 -e production 2&gt;&amp;1&#x000A;</pre>&#x000A;</div>&#x000A;&#x000A;&#x000A;<p>Zu guter letzt benötigt man unter <code>current/public</code> noch eine <code>.htaccess</code>-Datei, die eine RewriteRule&#x000A;enthält, um die Requests an den Applikationsserver-Proxy weiterzuleiten. Im einfachsten Fall reicht&#x000A;folgendes:</p>&#x000A;&#x000A;<div class="highlight"><pre><span class="nb">RewriteEngine</span> <span class="k">On</span>&#x000A;<span class="nb">RewriteBase</span> /&#x000A;<span class="nb">RewriteCond</span> %{REQUEST_FILENAME} !-f&#x000A;<span class="nb">RewriteRule</span> ^(.*)$ http://localhost:43862/$1 [P]&#x000A;</pre>&#x000A;</div>&#x000A;&#x000A;&#x000A;<p>Darüber hinaus gibt es hier auch noch eine Variante der <a href="https://gist.github.com/3656874"><code>.htaccess</code> mit Asset-Caching und Wartungsmodus</a>.</p>&#x000A;&#x000A;<p>Sowohl uberspacify als auch das Vlad-Script kümmern sich darum diese Dateien entsprechend der&#x000A;gegebenen Konfiguration zu generieren. Sollte jemand das Vlad-Script ausprobieren oder Anmerkungen&#x000A;zu den hier gegebenen Tipps haben freue ich mich natürlich über Feedback dazu :)</p>&#x000A;&#x000A;<h3>Bitte beachten!</h3>&#x000A;&#x000A;<p>Uberspace hat ein SSH-Connection Limit, was auch gut so ist. Vlad wiederum öffnet für jedes Kommando&#x000A;eine neue SSH-Verbindung, so dass man schnell mit dem Connection Limit kollidiert. Daher ist es sinnvoll,&#x000A;SSH-Multiplexing zu aktivieren, was man mit folgenden Zeilen in der <code>~/.ssh/config</code> tun kann:</p>&#x000A;&#x000A;<div class="highlight"><pre>Host *&#x000A;  ControlMaster auto&#x000A;  ControlPath /tmp/ssh-master-%r@%h:%p&#x000A;  ControlPersist 15m&#x000A;</pre>&#x000A;</div>&#x000A;&#x000A;&#x000A;<p>Dies führt dazu, dass bei jedem weiteren Befehl die bereits bestehende SSH-Verbindung genutzt wird.&#x000A;Man hat somit auch gleich ein schnelleres Deployment, daher wird auch in der <a href="http://hitsquad.rubyforge.org/vlad/doco/faq_txt.html">Vlad FAQ</a>&#x000A;generell dazu geraten, SSH-Multiplexing zu verwenden.</p></div>
        <div class='follow'>
          <p>
            Guter Artikel? Folge mir auf
            <a class="twitter" href="https://twitter.com/dennisreimann">Twitter</a>
            oder
            <a class="github" href="https://github.com/dennisreimann">GitHub</a>
          </p>
        </div>
        <div class='teaser' id='iOctocat' itemscope='itemscope' itemtype='http://schema.org/SoftwareApplication'>
          <a href='http://ioctocat.com'>
            <img alt='iOS app for GitHub' itemprop='image' src='/images/ioctocat.png' />
          </a>
          <h3 itemprop='name'>
            <a href='http://ioctocat.com'>iOctocat</a>
          </h3>
          <p itemprop='description'>
            ist GitHub für die Hosentasche - deine Projekte und das was dort passiert
            immer dabei mit deinem
            <span itemprop='device'>iPhone und iPod Touch.</span>
            <br />
            Die App ist
            <a href="http://ioctocat.com/appstore-iphone" itemprop="url">im App Store erhältlich</a>
          </p>
          <link href='http://schema.org/SocialNetworkingApplication' itemprop='SoftwareApplicationCategory' />
        </div>
      </article>
    </div>
    <div id="footer">
      <div class='vcard' id='contact'>
        <span class='fn'>Dennis Reimann</span>
        <p class='adr'>
          <span class='street-address'>Ottjen-Alldag-Str. 32</span>
          <br />
          <span class='postal-code'>D-28277</span>
          <span class='locality'>Bremen</span>
        </p>
        <p>
          <span class='web'><a class="url" href="http://dennisreimann.de/" rel="me">dennisreimann.de</a></span>
          <br />
          <span class='mail'><a class="email" href="mailto:mail@dennisreimann.de" rel="me">mail@dennisreimann.de</a></span>
          <br />
          <span class='tel'>+49 (0)151 22 63 03 17</span>
        </p>
        <p>
          <small><a href="/contact">Kontaktdetails</a></small>
        </p>
        <ul class='social'>
          <li><a href="https://github.com/dennisreimann" rel="me">GitHub</a></li>
          <li><a href="https://twitter.com/dennisreimann" rel="me">Twitter</a></li>
          <li><a href="http://www.xing.com/profile/Dennis_Reimann5" rel="me">XING</a></li>
        </ul>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-376258-21']);
        _gaq.push(['_gat._anonymizeIp']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
        })();
      //]]>
    </script>
  </body>
</html>
