<!DOCTYPE html>
<html>
  <head>
    <title>Rails deployment with Vlad, Git and Passenger | Dennis Reimann, Softwareentwickler</title>
    <script src='/javascripts/head.min.js'></script>
    <script type='text/javascript'>
      //<![CDATA[
        head.js(
          "https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js",
          "http://www.google-analytics.com/ga.js",
          "/fancybox/jquery.fancybox-1.3.4.pack.js",
          "/fancybox/jquery.easing-1.3.pack.js",
          "/javascripts/website.js",
          function(){Website.init()});
      //]]>
    </script>
    <link href='/atom.xml' rel='alternate' title='//dennisreimann' type='application/atom+xml' />
    <link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css' />
    <link href='/stylesheets/screen.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <link href='http://dennisreimann.de/blog/rails-deployment-with-vlad-git-and-passenger' rel='canonical' />
    <link href='http://openid.dennisreimann.de/server' rel='openid2.provider openid.server' />
    <link href='http://openid.dennisreimann.de/dennisreimann' rel='openid2.local_id openid.delegate' />
    <!--[if IE]>
      <link href='/stylesheets/ie.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <![endif]-->
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
    <meta content='BRi3ql7JvxxFP2KtBRHIV6Rfzn0ZN7xJF1NNtnEUaI8' name='google-site-verification' />
    <meta content='app-id=669642611,affiliate-data=10l5ET' name='apple-itunes-app' />
    <meta content='Now that Capistrano is discontinued, Vlad seems to be the new cool deployment tool on the block.' name='description' />
    <meta content='Deployment, Git, Passenger, Rails, Vlad,, Ruby' name='keywords' />
  </head>
  <body>
    <div id="header">
      <div id='identity'>
        <a href='/' id='logo'>
          <span id='slashes'>//</span>
          <span id='name'>dennisreimann</span>
        </a>
        <div id='claim'>
          Software developer
        </div>
      </div>
    </div>
    <div id="main">
      <article>
        <header>
          <time class='pubdate' datetime='2009-03-22T16:47:00+01:00'>
            <div class='top'>Mar '09</div>
            <div class='day'>22</div>
          </time>
          <h1>Rails deployment with Vlad, Git and Passenger</h1>
        </header>
        <div class='content'><p>Now that <a href="http://weblog.jamisbuck.org/2009/2/25/net-ssh-capistrano-and-saying-goodbye">Capistrano is discontinued</a>, <a href="http://rubyhitsquad.com/Vlad_the_Deployer.html">Vlad</a> (at <a href="https://github.com/seattlerb/vlad/tree/master">GitHub</a>) seems to be the new cool deployment tool on the block. It works nicely with other usual suspects like Git and Passenger and uses Rake instead of reinventing the wheel - so let&#8217;s have a closer look.</p>&#x000A;&#x000A;<h3>Getting started</h3>&#x000A;&#x000A;<p>First of you need to install the Vlad gem: <code>$ sudo gem install vlad</code></p>&#x000A;&#x000A;<p>In its current version (1.3.2) Vlads default options are deploying from a SVN repository to a cluster of mongrels, which is not exactly what we are after. We need to configure it to use Git and Passenger, so switch to your Rails project and add the following lines to the end of the <em>Rakefile</em>:</p>&#x000A;&#x000A;<div class="highlight"><pre><span class="k">begin</span>&#x000A;  <span class="nb">require</span> <span class="s1">&#39;vlad&#39;</span>&#x000A;  <span class="no">Vlad</span><span class="o">.</span><span class="n">load</span> <span class="ss">:app</span> <span class="o">=&gt;</span> <span class="ss">:passenger</span><span class="p">,</span> <span class="ss">:scm</span> <span class="o">=&gt;</span> <span class="ss">:git</span>&#x000A;<span class="k">rescue</span> <span class="no">LoadError</span>&#x000A;  <span class="nb">puts</span> <span class="s1">&#39;Could not load Vlad&#39;</span>&#x000A;<span class="k">end</span>&#x000A;</pre>&#x000A;</div>&#x000A;&#x000A;&#x000A;<p>Run <code>$ rake -T vlad</code> to verify that Rake and Vlad know each other.</p>&#x000A;&#x000A;<p>Now it&#8217;s time to <a href="http://hitsquad.rubyforge.org/vlad/doco/getting_started_txt.html">set up</a> your deployment configuration. Configuring Vlad is very similar to Capistrano, most of the <a href="http://hitsquad.rubyforge.org/vlad/doco/variables_txt.html">variables</a> are the same, so that you can easily <a href="http://hitsquad.rubyforge.org/vlad/doco/migration_txt.html">migrate</a> if you where using Capistrano before. Here is a simple configuration file including a deployment recipe which I&#8217;m currently using:</p>&#x000A;&#x000A;<div class="highlight"><pre><span class="n">set</span> <span class="ss">:user</span><span class="p">,</span> <span class="s2">&quot;myuser&quot;</span>&#x000A;<span class="n">set</span> <span class="ss">:domain</span><span class="p">,</span> <span class="s2">&quot;my.domain.com&quot;</span>&#x000A;<span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s2">&quot;myapp&quot;</span>&#x000A;<span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/var/www/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">&quot;</span>&#x000A;<span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span> <span class="s2">&quot;git@github.com:</span><span class="si">#{</span><span class="n">user</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">.git&quot;</span>&#x000A;&#x000A;<span class="n">namespace</span> <span class="ss">:vlad</span> <span class="k">do</span>&#x000A;  <span class="n">desc</span> <span class="s2">&quot;Symlinks the configuration files&quot;</span>&#x000A;  <span class="n">remote_task</span> <span class="ss">:symlink_config</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:web</span> <span class="k">do</span>&#x000A;    <span class="sx">%w(application.yml database.yml)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>&#x000A;      <span class="n">run</span> <span class="s2">&quot;ln -s </span><span class="si">#{</span><span class="n">shared_path</span><span class="si">}</span><span class="s2">/config/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2"> </span><span class="si">#{</span><span class="n">current_path</span><span class="si">}</span><span class="s2">/config/</span><span class="si">#{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;&#x000A;  <span class="n">desc</span> <span class="s2">&quot;Full deployment cycle: Update, migrate, restart, cleanup&quot;</span>&#x000A;  <span class="n">remote_task</span> <span class="ss">:deploy</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span> <span class="k">do</span>&#x000A;    <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;vlad:update&#39;</span><span class="o">].</span><span class="n">invoke</span>&#x000A;    <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;vlad:symlink_config&#39;</span><span class="o">].</span><span class="n">invoke</span>&#x000A;    <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;vlad:migrate&#39;</span><span class="o">].</span><span class="n">invoke</span>&#x000A;    <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;vlad:start_app&#39;</span><span class="o">].</span><span class="n">invoke</span>&#x000A;    <span class="ss">Rake</span><span class="p">:</span><span class="ss">:Task</span><span class="o">[</span><span class="s1">&#39;vlad:cleanup&#39;</span><span class="o">].</span><span class="n">invoke</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</pre>&#x000A;</div>&#x000A;&#x000A;&#x000A;<h3>Gotchas</h3>&#x000A;&#x000A;<p>It took me a while to get everything up and running because I encountered permission problems while trying to access the application repository from my deployment server. If you are running <code>$ rake vlad:update</code> and experience Git errors like <code>fetch-pack from '...' failed</code>, turn to <a href="http://jordanelver.co.uk/articles/2008/07/10/rails-deployment-with-git-vlad-and-ssh-agent-forwarding/">Jordan Elvers blog post about it</a> - he explains how you can solve this by setting up SSH agent forwarding.</p>&#x000A;&#x000A;<h3>Advancing</h3>&#x000A;&#x000A;<p>Need to go further and setup a multistage deployment environment? Check out <a href="http://blog.engineyard.com/2008/10/20/multi-environment-merb-dm-deployment-with-vlad-git">this post</a> on the Engine Yard blog, they solved this problem already.</p></div>
        <div class='follow'>
          <p>
            Liked this post? Follow me on
            <a class="twitter" href="https://twitter.com/dennisreimann">Twitter</a>
            or
            <a class="github" href="https://github.com/dennisreimann">GitHub</a>
          </p>
        </div>
        <div class='teaser' id='iOctocat' itemscope='itemscope' itemtype='http://schema.org/SoftwareApplication'>
          <a href='http://ioctocat.com'>
            <img alt='iPhone app for GitHub' itemprop='image' src='/images/ioctocat.png' />
          </a>
          <h3 itemprop='name'>
            <a href='http://ioctocat.com'>
              iOctocat
            </a>
          </h3>
          <p itemprop='description'>
            is GitHub in your pocket: The go to app for staying up to date with your
            projects on your
            <span itemprop='device'>iPhone, and iPod Touch.</span>
            <br />
            It is
            <a href="http://ioctocat.com/appstore-iphone" itemprop="url">available on the App Store</a>
          </p>
          <link href='http://schema.org/SocialNetworkingApplication' itemprop='SoftwareApplicationCategory' />
        </div>
      </article>
    </div>
    <div id="footer">
      <div class='vcard' id='contact'>
        <span class='fn'>Dennis Reimann</span>
        <p class='adr'>
          <span class='street-address'>Ottjen-Alldag-Str. 32</span>
          <br />
          <span class='postal-code'>D-28277</span>
          <span class='locality'>Bremen</span>
        </p>
        <p>
          <span class='web'><a class="url" href="http://dennisreimann.de/" rel="me">dennisreimann.de</a></span>
          <br />
          <span class='mail'><a class="email" href="mailto:mail@dennisreimann.de" rel="me">mail@dennisreimann.de</a></span>
          <br />
          <span class='tel'>+49 (0)151 22 63 03 17</span>
        </p>
        <p>
          <small><a href="/contact">Contact details</a></small>
        </p>
        <ul class='social'>
          <li><a href="https://github.com/dennisreimann" rel="me">GitHub</a></li>
          <li><a href="https://twitter.com/dennisreimann" rel="me">Twitter</a></li>
          <li><a href="http://www.xing.com/profile/Dennis_Reimann5" rel="me">XING</a></li>
        </ul>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-376258-21']);
        _gaq.push(['_gat._anonymizeIp']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
        })();
      //]]>
    </script>
  </body>
</html>
