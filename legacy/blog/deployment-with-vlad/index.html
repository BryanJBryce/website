<!DOCTYPE html>
<html>
  <head>
    <title>Deployment with Vlad | Dennis Reimann, Softwareentwickler</title>
    <script src='/javascripts/head.min.js'></script>
    <script type='text/javascript'>
      //<![CDATA[
        head.js(
          "https://ajax.googleapis.com/ajax/libs/jquery/1.7.0/jquery.min.js",
          "http://www.google-analytics.com/ga.js",
          "/fancybox/jquery.fancybox-1.3.4.pack.js",
          "/fancybox/jquery.easing-1.3.pack.js",
          "/javascripts/website.js",
          function(){Website.init()});
      //]]>
    </script>
    <link href='/atom.xml' rel='alternate' title='//dennisreimann' type='application/atom+xml' />
    <link href='/stylesheets/print.css' media='print' rel='stylesheet' type='text/css' />
    <link href='/stylesheets/screen.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <link href='http://dennisreimann.de/blog/deployment-with-vlad' rel='canonical' />
    <link href='http://openid.dennisreimann.de/server' rel='openid2.provider openid.server' />
    <link href='http://openid.dennisreimann.de/dennisreimann' rel='openid2.local_id openid.delegate' />
    <!--[if IE]>
      <link href='/stylesheets/ie.css' media='screen, projection' rel='stylesheet' type='text/css' />
    <![endif]-->
    <meta content='text/html; charset=UTF-8' http-equiv='Content-Type' />
    <meta content='BRi3ql7JvxxFP2KtBRHIV6Rfzn0ZN7xJF1NNtnEUaI8' name='google-site-verification' />
    <meta content='app-id=669642611,affiliate-data=10l5ET' name='apple-itunes-app' />
    <meta content='Softwareentwicklung mit Ruby on Rails' name='description' />
    <meta content='Vlad, Ruby, Rails, Deployment, Capistrano' name='keywords' />
  </head>
  <body>
    <div id="header">
      <div id='identity'>
        <a href='/' id='logo'>
          <span id='slashes'>//</span>
          <span id='name'>dennisreimann</span>
        </a>
        <div id='claim'>
          Software developer
        </div>
      </div>
    </div>
    <div id="main">
      <article>
        <header>
          <time class='pubdate' datetime='2012-02-11T19:16:00+01:00'>
            <div class='top'>Feb '12</div>
            <div class='day'>11</div>
          </time>
          <hgroup>
            <h1>Deployment with Vlad</h1>
            <h2>Application deployment based on Rake</h2>
          </hgroup>
        </header>
        <div class='content'><p>When I ask people about how they deploy their Rails apps, most of them answer that they are using good old <a href="http://capify.org">Capistrano</a>. It is the most popular solution because it has been around since almost when people started deploying Rails applications and it works well in most cases. However, if you want to do a lot of custom tasks and need to look under the hood to extend it, Capistrano seems somewhat complicated. At least it did at the time I left it in favor of <a href="http://rubyhitsquad.com/Vlad_the_Deployer.html">Vlad</a> - an <em>imho</em> more intuitive deployment tool.</p>&#x000A;&#x000A;<p>Though one might not like the <a href="http://rubyhitsquad.com/Ruby_Hit_Squad.html">offense against Capistrano</a> that was shown when Vlad was released in 2007, it addresses <a href="http://www.infoq.com/news/2007/08/vlad-the-deployer">some valid points</a> when arguing against needless complexity. But enough of the history, this was almost five years ago, both of the tools have improved, made their way and all I wanted to share is some snippets and insights I got from using Vlad over the last years.</p>&#x000A;&#x000A;<p>The main thing I like abot Vlad is that it is based on Rake, which makes it so easy to learn, understand and extend. If you want to do something custom, all you have to do is to write a Rake task. And as you will want to use them across different projects, you can even bundle them up and distribute them as a gem, like I&#8217;ve done with <a href="https://github.com/dennisreimann/vlad-extras">vlad-extras</a>, a set of extensions for tools like DelayedJob, ThinkingSphinx, Monit, Whenever and so on.</p>&#x000A;&#x000A;<p>Here is what a simple <code>config/deploy.rb</code> file might look like:</p>&#x000A;&#x000A;<div class="highlight"><pre><span class="c1"># Custom variables used in the following config</span>&#x000A;<span class="n">set</span> <span class="ss">:application</span><span class="p">,</span> <span class="s2">&quot;appname&quot;</span>&#x000A;&#x000A;<span class="c1"># Required variables</span>&#x000A;<span class="n">set</span> <span class="ss">:domain</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">.com&quot;</span>&#x000A;<span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/var/www/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">&quot;</span>&#x000A;<span class="n">set</span> <span class="ss">:repository</span><span class="p">,</span> <span class="s2">&quot;git@github.com:myaccount/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">.git&quot;</span>&#x000A;&#x000A;<span class="c1"># Optional variables</span>&#x000A;<span class="n">set</span> <span class="ss">:user</span><span class="p">,</span> <span class="s2">&quot;deploy&quot;</span> <span class="c1"># if different from your current login</span>&#x000A;<span class="n">set</span> <span class="ss">:bundle_cmd</span><span class="p">,</span> <span class="s2">&quot;/usr/local/bin/bundle&quot;</span>&#x000A;<span class="n">set</span> <span class="ss">:rake_cmd</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">bundle_cmd</span><span class="si">}</span><span class="s2"> exec rake&quot;</span>&#x000A;<span class="n">set</span> <span class="ss">:revision</span><span class="p">,</span> <span class="s2">&quot;origin/master&quot;</span>&#x000A;&#x000A;<span class="c1"># vlad-extras config</span>&#x000A;<span class="n">set</span> <span class="ss">:copy_shared</span><span class="p">,</span> <span class="p">{</span>&#x000A;  <span class="s1">&#39;config/maintenance.html&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;config/maintenance.html&#39;</span><span class="p">,</span>&#x000A;  <span class="s1">&#39;config/database.yml&#39;</span>     <span class="o">=&gt;</span> <span class="s1">&#39;config/database.yml&#39;</span> <span class="p">}</span>&#x000A;<span class="n">set</span> <span class="ss">:symlinks</span><span class="p">,</span> <span class="p">{</span>&#x000A;  <span class="s1">&#39;assets&#39;</span>              <span class="o">=&gt;</span> <span class="s1">&#39;public/assets&#39;</span><span class="p">,</span>&#x000A;  <span class="s1">&#39;config/database.yml&#39;</span> <span class="o">=&gt;</span> <span class="s1">&#39;config/database.yml&#39;</span> <span class="p">}</span>&#x000A;<span class="n">set</span> <span class="ss">:deploy_tasks</span><span class="p">,</span> <span class="sx">%w(</span>&#x000A;<span class="sx">  vlad:maintenance:on</span>&#x000A;<span class="sx">  vlad:update</span>&#x000A;<span class="sx">  vlad:symlink</span>&#x000A;<span class="sx">  vlad:bundle:install</span>&#x000A;<span class="sx">  vlad:assets:precompile</span>&#x000A;<span class="sx">  vlad:migrate</span>&#x000A;<span class="sx">  vlad:start_app</span>&#x000A;<span class="sx">  vlad:maintenance:off</span>&#x000A;<span class="sx">  vlad:cleanup)</span>&#x000A;&#x000A;<span class="c1"># Bundler ships with vlad integration you&#39;ll have to require</span>&#x000A;<span class="c1"># in order to use the vlad:bundle tasks</span>&#x000A;<span class="nb">require</span> <span class="s1">&#39;bundler/vlad&#39;</span>&#x000A;&#x000A;<span class="c1"># Require custom vlad tasks or recipes from vlad-extras</span>&#x000A;<span class="nb">require</span> <span class="s1">&#39;vlad/maintenance&#39;</span>&#x000A;&#x000A;<span class="c1"># Some custom tasks, can be included directly in the deploy file</span>&#x000A;<span class="n">namespace</span> <span class="ss">:vlad</span> <span class="k">do</span>&#x000A;  <span class="n">namespace</span> <span class="ss">:custom_script</span> <span class="k">do</span>&#x000A;    <span class="sx">%w(start stop restart)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">task</span><span class="o">|</span>&#x000A;      <span class="n">desc</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">task</span><span class="o">.</span><span class="n">capitalize</span><span class="si">}</span><span class="s2"> the custom script&quot;</span>&#x000A;      <span class="n">remote_task</span> <span class="n">task</span><span class="p">,</span> <span class="ss">:roles</span> <span class="o">=&gt;</span> <span class="ss">:app</span> <span class="k">do</span>&#x000A;        <span class="n">run</span> <span class="s2">&quot;cd </span><span class="si">#{</span><span class="n">current_release</span><span class="si">}</span><span class="s2">; RAILS_ENV=</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2"></span>&#x000A;<span class="s2">          </span><span class="si">#{</span><span class="n">bundle_cmd</span><span class="si">}</span><span class="s2"> exec ruby script/custom </span><span class="si">#{</span><span class="n">task</span><span class="si">}</span><span class="s2">&quot;</span>&#x000A;      <span class="k">end</span>&#x000A;    <span class="k">end</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</pre>&#x000A;</div>&#x000A;&#x000A;&#x000A;<p>Here is an example of how easy it is for instance to add staging support:</p>&#x000A;&#x000A;<div class="highlight"><pre><span class="n">task</span> <span class="ss">:staging</span> <span class="k">do</span>&#x000A;  <span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="s2">&quot;staging&quot;</span>&#x000A;  <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/var/www/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">&quot;</span>&#x000A;<span class="k">end</span>&#x000A;&#x000A;<span class="n">task</span> <span class="ss">:production</span> <span class="k">do</span>&#x000A;  <span class="n">set</span> <span class="ss">:rails_env</span><span class="p">,</span> <span class="s2">&quot;production&quot;</span>&#x000A;  <span class="n">set</span> <span class="ss">:deploy_to</span><span class="p">,</span> <span class="s2">&quot;/var/www/</span><span class="si">#{</span><span class="n">application</span><span class="si">}</span><span class="s2">-</span><span class="si">#{</span><span class="n">rails_env</span><span class="si">}</span><span class="s2">&quot;</span>&#x000A;<span class="k">end</span>&#x000A;</pre>&#x000A;</div>&#x000A;&#x000A;&#x000A;<p>All you need to do is to change some variables based on the environment that is set with a simple Rake task. You&#8217;d invoke it by running</p>&#x000A;&#x000A;<pre><code>$ bundle exec rake staging vlad:deploy&#x000A;</code></pre>&#x000A;&#x000A;<h3>Gemfile</h3>&#x000A;&#x000A;<p>You can include Vlad and it&#8217;s requirements in the development group, because it you do not need it in any other environment. Requiring is done in the <code>Rakefile</code> like shown below.</p>&#x000A;&#x000A;<div class="highlight"><pre><span class="n">group</span> <span class="ss">:development</span> <span class="k">do</span>&#x000A;  <span class="c1"># Deployment</span>&#x000A;  <span class="n">gem</span> <span class="s1">&#39;vlad&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>&#x000A;  <span class="n">gem</span> <span class="s1">&#39;vlad-git&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>&#x000A;  <span class="n">gem</span> <span class="s1">&#39;vlad-extras&#39;</span><span class="p">,</span> <span class="ss">:require</span> <span class="o">=&gt;</span> <span class="kp">false</span>&#x000A;<span class="k">end</span>&#x000A;</pre>&#x000A;</div>&#x000A;&#x000A;&#x000A;<h3>Rakefile</h3>&#x000A;&#x000A;<p>Add this snippet to your Rakefile, just before <code>MyApp::Application.load_tasks</code></p>&#x000A;&#x000A;<div class="highlight"><pre><span class="k">if</span> <span class="no">Rails</span><span class="o">.</span><span class="n">env</span><span class="o">.</span><span class="n">development?</span>&#x000A;  <span class="k">begin</span>&#x000A;    <span class="nb">require</span> <span class="s1">&#39;vlad&#39;</span>&#x000A;    <span class="nb">require</span> <span class="s1">&#39;vlad-extras&#39;</span>&#x000A;    <span class="no">Vlad</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="ss">scm</span><span class="p">:</span> <span class="ss">:git</span><span class="p">,</span> <span class="ss">web</span><span class="p">:</span> <span class="ss">:nginx</span><span class="p">,</span> <span class="ss">app</span><span class="p">:</span> <span class="ss">:passenger</span><span class="p">,</span> <span class="ss">type</span><span class="p">:</span> <span class="ss">:rails</span><span class="p">)</span>&#x000A;  <span class="k">rescue</span> <span class="no">LoadError</span>&#x000A;    <span class="nb">puts</span> <span class="s1">&#39;Could not load Vlad&#39;</span>&#x000A;  <span class="k">end</span>&#x000A;<span class="k">end</span>&#x000A;</pre>&#x000A;</div>&#x000A;&#x000A;&#x000A;<p>You might have to configure the options given to <code>Vlad.load</code>.</p>&#x000A;&#x000A;<p>If you want to get started, take a look at <a href="http://hitsquad.rubyforge.org/vlad/">the documentation</a> to find out about the parts that this post leaves out.</p>&#x000A;&#x000A;<h2>Troubleshooting</h2>&#x000A;&#x000A;<p>This part is about some trouble I&#8217;ve had and it is not really Vlad specific. You might encounter these problems when trying to deploy to your production server and maybe these tips and links will help.</p>&#x000A;&#x000A;<h3>The deployment shell environment</h3>&#x000A;&#x000A;<p>If Vlad does not find some commands, try the following:</p>&#x000A;&#x000A;<p>To enable per user PATH environments for ssh logins you need to add to your <code>sshd_config</code>:</p>&#x000A;&#x000A;<pre><code>PermitUserEnvironment yes&#x000A;</code></pre>&#x000A;&#x000A;<p>After that, restart sshd!</p>&#x000A;&#x000A;<p>Then in your users ssh home directory (<code>~/.ssh/environment</code>), add something to this effect (your mileage will vary):</p>&#x000A;&#x000A;<pre><code>PATH=/opt/ruby-1.9.3/bin:/usr/local/bin:/bin:/usr/bin&#x000A;</code></pre>&#x000A;&#x000A;<p>For details on that, see this article on <a href="http://zerobearing.com/2009/04/27/capistrano-rake-command-not-found">setting the deployment shell environment</a></p>&#x000A;&#x000A;<h3>SSH Agent Forwarding</h3>&#x000A;&#x000A;<p>Maybe you also need to configure SSH Agent Forwarding:</p>&#x000A;&#x000A;<pre><code>$ ssh-add ~/.ssh/&lt;private_keyname&gt;&#x000A;</code></pre>&#x000A;&#x000A;<p>Edit your <code>~/.ssh/config</code> file and add something like this:</p>&#x000A;&#x000A;<pre><code>Host &lt;name&gt;&#x000A;  HostName &lt;ip or host&gt;&#x000A;  User &lt;username&gt;&#x000A;  IdentityFile ~/.ssh/&lt;filename&gt;&#x000A;  ForwardAgent yes&#x000A;</code></pre>&#x000A;&#x000A;<p>For details on that see this article on <a href="http://jordanelver.co.uk/articles/2008/07/10/rails-deployment-with-git-vlad-and-ssh-agent-forwarding/">SSH Agent Forwarding</a></p></div>
        <div class='follow'>
          <p>
            Liked this post? Follow me on
            <a class="twitter" href="https://twitter.com/dennisreimann">Twitter</a>
            or
            <a class="github" href="https://github.com/dennisreimann">GitHub</a>
          </p>
        </div>
        <div class='teaser' id='iOctocat' itemscope='itemscope' itemtype='http://schema.org/SoftwareApplication'>
          <a href='http://ioctocat.com'>
            <img alt='iPhone app for GitHub' itemprop='image' src='/images/ioctocat.png' />
          </a>
          <h3 itemprop='name'>
            <a href='http://ioctocat.com'>
              iOctocat
            </a>
          </h3>
          <p itemprop='description'>
            is GitHub in your pocket: The go to app for staying up to date with your
            projects on your
            <span itemprop='device'>iPhone, and iPod Touch.</span>
            <br />
            It is
            <a href="http://ioctocat.com/appstore-iphone" itemprop="url">available on the App Store</a>
          </p>
          <link href='http://schema.org/SocialNetworkingApplication' itemprop='SoftwareApplicationCategory' />
        </div>
      </article>
    </div>
    <div id="footer">
      <div class='vcard' id='contact'>
        <span class='fn'>Dennis Reimann</span>
        <p class='adr'>
          <span class='street-address'>Ottjen-Alldag-Str. 32</span>
          <br />
          <span class='postal-code'>D-28277</span>
          <span class='locality'>Bremen</span>
        </p>
        <p>
          <span class='web'><a class="url" href="http://dennisreimann.de/" rel="me">dennisreimann.de</a></span>
          <br />
          <span class='mail'><a class="email" href="mailto:mail@dennisreimann.de" rel="me">mail@dennisreimann.de</a></span>
          <br />
          <span class='tel'>+49 (0)151 22 63 03 17</span>
        </p>
        <p>
          <small><a href="/contact">Contact details</a></small>
        </p>
        <ul class='social'>
          <li><a href="https://github.com/dennisreimann" rel="me">GitHub</a></li>
          <li><a href="https://twitter.com/dennisreimann" rel="me">Twitter</a></li>
          <li><a href="http://www.xing.com/profile/Dennis_Reimann5" rel="me">XING</a></li>
        </ul>
      </div>
    </div>
    <script type='text/javascript'>
      //<![CDATA[
        var _gaq = _gaq || [];
        _gaq.push(['_setAccount', 'UA-376258-21']);
        _gaq.push(['_gat._anonymizeIp']);
        _gaq.push(['_trackPageview']);

        (function() {
          var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
          ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(ga);
        })();
      //]]>
    </script>
  </body>
</html>
